<!doctype html><html><head><meta charset=UTF-8><title>JavaScript异步编程-小结 - By luo0412</title><link rel=stylesheet href=//cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet href=//cdn.staticfile.org/prism/1.15.0/themes/prism.min.css><link rel=stylesheet href=//cdn.staticfile.org/KaTeX/0.10.0-rc.1/katex.min.css><link rel=stylesheet href=/static/css/nodeppt.css><link href=./css/chunk-vendors.cdf61d2f.css rel=stylesheet></head><body><div><article id=webslides><section slide class="slide bg-black-blue aligncenter" image="https://cn.bing.com/az/hprichbg/rb/RainierDawn_EN-AU3730494945_1920x1080.jpg .dark"><span class="background dark" style="background-image:url('https://cn.bing.com/az/hprichbg/rb/RainierDawn_EN-AU3730494945_1920x1080.jpg')"></span><div class=wrap wrap=true><h1 class="text-landing text-shadow">JavaScript异步编程</h1><hr><h2 class="text-intro animated fadeInUp delay-500">2019-12-12</h2><h2 class="text-intro animated fadeInUp delay-500">@by luo0412</h2><p><a href=https://github.com/ui-javascript/ppt class="button ghost animated flipInX delay-1200" target=_blank><i class="fa fa-github"></i> Github</a></p></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>JavaScript-异步编程</h2><hr><ul><li>JavaScript异步编程六种方案 @simple<ul><li><a href=https://juejin.im/post/5c30375851882525ec200027 target=_blank>https:://juejin.im/post/5c30375851882525ec200027</a></li><li>回调函数（Callback）</li><li>事件监听</li><li>发布订阅</li><li>Promise/A+</li><li>生成器Generators/ yield</li><li>async/await</li></ul></li></ul></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>JavaScript异步编程发展史</h2><hr><blockquote><p>基于共享内存模型的伪线程模型</p></blockquote><ul><li><code>异步模型发展</code><ul><li>Callback/事件监听/发布订阅</li><li>--&gt; JSDeferred/jQuery Deferred</li><li>--&gt; <code>promise</code></li><li>--&gt; generator/yield*</li><li>--&gt; <code>(async+await)</code>/(await+promise)</li></ul></li><li><code>数据交互发展</code><ul><li>ajax(XMLHttpRequest)</li><li>-&gt; JSONP(基于script节点)</li><li>--&gt; <code>jQuery.ajax</code></li><li>--&gt; <code>fetch</code>(jQuery.ajax的官方版本)</li></ul></li></ul></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>Callback 回调地狱</h2><hr><pre class=language-js><code class=language-js><span class="token function">ajax</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// 处理逻辑</span>
    <span class="token function">ajax</span><span class="token punctuation">(</span>url1<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token comment">// 处理逻辑</span>
        <span class="token function">ajax</span><span class="token punctuation">(</span>url2<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token comment">// 处理逻辑</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>观察者模式 Observers</h2><hr><ul><li>也就是<code>发布订阅</code></li><li>Node.js <code>EventEmitter</code><ul><li><a href=https://github.com/Olical/EventEmitter target=_blank>https:://github.com/Olical/EventEmitter</a> @nice --&gt; browser</li><li><a href=https://github.com/EventEmitter2/EventEmitter2 target=_blank>https:://github.com/EventEmitter2/EventEmitter2</a></li><li><a href=https://github.com/primus/eventemitter3 target=_blank>https:://github.com/primus/eventemitter3</a></li></ul></li></ul></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>EventEmitter</h2><hr><pre class=language-js><code class=language-js><span class="token keyword">var</span> ee <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ee<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token string">'create-user'</span><span class="token punctuation">,</span> sendCreateRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
ee<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token string">'request-complete'</span><span class="token punctuation">,</span> displayResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">sendCreateRequest</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">sendRequest</span><span class="token punctuation">(</span><span class="token string">'create'</span><span class="token punctuation">,</span> arguments<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">success<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ee<span class="token punctuation">.</span><span class="token function">emitEvent</span><span class="token punctuation">(</span><span class="token string">'request-complete'</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">displayResponse</span><span class="token punctuation">(</span><span class="token parameter">success<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Yay!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Boo!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">sendRequest</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> data<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Kick everything off by emitting a create-user event.</span>
ee<span class="token punctuation">.</span><span class="token function">emitEvent</span><span class="token punctuation">(</span><span class="token string">'create-user'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'Oliver Caldwell'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>事件监听 listeners</h2><hr><pre class=language-js><code class=language-js><span class="token keyword">function</span> <span class="token function">a</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> pubsub <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">pubSub</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token keyword">in</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> pubsub<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
<span class="token punctuation">}</span>

a<span class="token punctuation">.</span>handlers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token comment">// 数据自己保存，不共存</span>
a<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">b</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hello callback'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>事件机制 vs 观察者模式 @diff</h2><hr><ul><li><p>事件监听</p><ul><li>缺点:: 事件驱动, 很难看出主流程</li><li>优点:: 当目标对象被删除的时候，不会给整个系统残留一些无用的负担</li></ul></li><li><p>观察者模式</p></li><li><p>它们适合监听<code>多次同类型</code>的异步行为, 不适合<code>一次性</code>的异步行为</p></li></ul></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>JSDeferred</h2><hr><blockquote><p>Promise基石</p></blockquote><ul><li>@code <a href=https://github.com/cho45/jsdeferred target=_blank>https:://github.com/cho45/jsdeferred</a></li><li><code>单向链表</code></li><li>Deferred.next() @nice</li><li>Deferred.parallel() --&gt; 并归处理 --&gt; 3次重载</li><li>Deferred.connect()</li></ul></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>JSDeferred</h2><hr><pre class=language-js><code class=language-js><span class="token comment">// Define</span>
Deferred<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// next</span>
<span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"Hello!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"World!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// parallel</span>
<span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    http<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/foo.json"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    http<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/bar.json"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    http<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/baz.json"</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">results</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// connect </span>
<span class="token comment">// 将函数封装成Deferred对象 --> 融入异步编程</span>
<span class="token keyword">var</span> timeout <span class="token operator">=</span> Deferred<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>setTimeout<span class="token punctuation">,</span> <span class="token punctuation">{</span> target<span class="token punctuation">:</span> window<span class="token punctuation">,</span> ok<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">timeout</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'after 1 sec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>jQuery Deferred @ignore</h2><hr><ul><li>API改了好几次, 没什么存在感!!</li><li>夹带太多的技术私货??</li><li>jQuery的Deferred基于<code>3个Callbacks</code></li></ul></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>Promise-教程</h2><hr><ul><li><p>MDN-promise</p><ul><li><a href=https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise target=_blank>https:://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise</a></li></ul></li><li><p>《ECMAScript 6 入门》-promise @nice</p><ul><li><a href=http://es6.ruanyifeng.com/##docs/promise target=_blank>http:://es6.ruanyifeng.com/##docs/promise</a></li></ul></li><li><p>JavaScript Promise迷你书</p><ul><li><a href=http://liubin.org/promises-book/ target=_blank>http://liubin.org/promises-book/</a></li></ul></li></ul></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>Promise-状态</h2><hr><ul><li><code>pending</code>（进行中）</li><li><code>fulfilled</code>（已成功）</li><li><code>rejected</code>（已失败）</li><li>一旦从等待状态变成为其他状态就永远<code>不能更改</code>状态了 --&gt; 如果你错过了它，再去监听，是得不到结果的</li></ul></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>Promise-方法</h2><hr><ul><li>链式API --&gt; 回调里可以直接返回Promise --&gt; 可以拿这个Promise接着撸代码</li><li>Promise.prototype.then()</li><li>Promise.prototype.catch()</li><li>Promise.prototype.finally() --&gt; then()的特例</li><li>Promise.all()/Promise.race()/Promise.allSettled()/Promise.any()</li><li>Promise.resolve()/Promise.reject()</li><li>@demo <a href=https://github.com/ui-javascript/natural-tpl-umi-mpa-react16-2019/blob/master/_ecma/async/promise/promise-all-catch.js target=_blank>链接</a></li></ul></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>Promise-库</h2><hr><ul><li>bluebird @nice --&gt; <code>后台</code>也可以用</li><li>when.js</li><li>q</li></ul><pre class=language-js><code class=language-js><span class="token keyword">var</span> Promise <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"bluebird"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Promise.promisifyAll(require("request"));</span>
<span class="token comment">// Promise.promisifyAll(require("redis"));</span>
<span class="token comment">// Promise.promisifyAll(require("mysql/lib/Connection").prototype);</span>

<span class="token keyword">var</span> readFile <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">promisify</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>readFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">"myfile.js"</span><span class="token punctuation">,</span> <span class="token string">"utf8"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">contents</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">eval</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"The result of evaluating myfile.js"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>SyntaxError<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"File had syntax error"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Error reading file"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>Promise-标准</h2><hr><ul><li>Promise/A --&gt; <code>Promise/A+</code> --&gt; <code>ES6</code>中采用</li><li>Promise/B</li><li>Promise/D</li></ul></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>Promise-执行顺序示例</h2><hr><ul><li>首先按顺序执行同步任务</li><li>执行栈空了，执行事件队列，取出微任务</li><li><code>微任务</code>永远在<code>宏任务</code>之前执行</li></ul><pre class=language-js><code class=language-js><span class="token comment">// 宏任务（macrotask ）</span>
setTimeout
setInterval
setImmediate
requestAnimationFrame

<span class="token comment">// 微任务（microtask ）</span>
Promise<span class="token punctuation">.</span>then catch finally
MutationObserver
process<span class="token punctuation">.</span>nextTick
</code></pre></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>Promise-执行顺序示例</h2><hr><pre class=language-js><code class=language-js><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'照样输出'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 输出顺序: </span>
<span class="token comment">// 2 -> 照样输出 -> 4 -> 3 -> 1</span>
</code></pre></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>Promise-缺点</h2><hr><ul><li><code>无法取消</code>Promise</li><li>不设置<code>回调函数</code>，Promise<code>内部抛出的错误</code>，就不会反应到外部</li><li><code>pending状态</code>不明确 --&gt; 刚刚开始?? 也可以是即将完成??</li></ul></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>手写Promise</h2><hr><ul><li><p>mmPromise.js</p><ul><li><a href=https://github.com/RubyLouvre/mmDeferred/blob/master/mmPromise.js target=_blank>https:://github.com/RubyLouvre/mmDeferred/blob/master/mmPromise.js</a></li></ul></li><li><p>Promise实现原理（附源码）</p><ul><li><a href=https://juejin.im/post/5b83cb5ae51d4538cc3ec354 target=_blank>https:://juejin.im/post/5b83cb5ae51d4538cc3ec354</a></li></ul></li><li><p>这一次，彻底弄懂 Promise 原理</p><ul><li><a href=https://juejin.im/post/5d6f7c83e51d4561c541a712 target=_blank>https:://juejin.im/post/5d6f7c83e51d4561c541a712</a></li></ul></li><li><p>@demo <a href=https://github.com/ui-javascript/natural-tpl-umi-mpa-react16-2019/blob/master/_ecma/async/my-promise/libs/myPromise.js target=_blank>链接</a></p></li></ul></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>Generator/yield* @ignore</h2><hr><blockquote><p>临时过渡</p></blockquote><ul><li>函数运行到yield时退出, 并<code>保留上下文</code>, 在下次进入时可以继续进行</li><li>浏览器支持并不好 --&gt; 很快就出了替代方案??</li><li>没有执行器</li><li>@demo <a href=https://github.com/ui-javascript/natural-tpl-umi-mpa-react16-2019/blob/master/_ecma/async/generator-yield/simple-yield-demo.js target=_blank>链接</a></li></ul></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>Generator/yield* @ignore</h2><hr><pre class=language-js><code class=language-js><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">yield</span> <span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 5 + 1 --> 6</span>
    <span class="token keyword">let</span> z <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token punctuation">(</span>y <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// 12 * 2 /3 --> 8</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>x <span class="token operator">+</span> y <span class="token operator">+</span> z<span class="token punctuation">)</span> <span class="token comment">// 5 + 24 + 13 --> 42</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> it <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>

<span class="token comment">// 当执行第一次 next 时，传参会被忽略</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">// => {value: 6, done: false}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// => {value: 8, done: false}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// => {value: 42, done: true}</span>
</code></pre></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>co库</h2><hr><ul><li>为Node.js和浏览器打造的基于<code>生成器</code>的<code>流程控制</code>工具 --&gt; 更加优雅的方式编写非阻塞代码</li><li>@code <a href=https://github.com/tj/co target=_blank>https:://github.com/tj/co</a></li></ul><pre class=language-js><code class=language-js><span class="token keyword">var</span> co <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'co'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">co</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// yield any promise</span>
  <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token keyword">yield</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>onerror<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">co</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// resolve multiple promises in parallel</span>
  <span class="token keyword">var</span> a <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> b <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> c <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> res <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token punctuation">[</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">]</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// => [1, 2, 3]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>onerror<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>Async/Await</h2><hr><blockquote><p>异步操作终极解决方案</p></blockquote><ul><li><code>语法糖</code></li><li>不需要类似co启动器 --&gt; <code>内置</code>执行器</li><li>比Generator更广的适用性</li><li><code>await + Promise + then</code> --&gt; 基本无敌</li><li>如果多个异步代码没有依赖性却使用了 await 会导致性能上的降低，代码没有依赖性的话，完全可以使用 Promise.all</li></ul><pre class=language-js><code class=language-js>co 函数库约定，
<span class="token keyword">yield</span> 命令后面只能是 Thunk 函数或 Promise 对象

<span class="token keyword">async</span> 函数的 <span class="token keyword">await</span> 命令后面，
可以跟 Promise 对象和原始类型的值（数值、字符串和布尔值，但这时等同于同步操作）
</code></pre></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>Async/Await-实践</h2><hr><ul><li>使用 ES2017 中的 Async(异步) 函数 和 Await(等待)<ul><li><a href=https://www.css88.com/archives/7980 target=_blank>https:://www.css88.com/archives/7980</a></li></ul></li></ul><pre class=language-js><code class=language-js><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>data<span class="token punctuation">,</span> setData<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"App"</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>h1<span class="token operator">></span>Hello <span class="token punctuation">{</span>data<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>异常处理</h2><hr><ul><li>同步代码 --&gt; try/catch</li><li>非同步代码 --&gt; error-first</li></ul></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>Fetch</h2><hr><blockquote><p>用于取代xhr</p></blockquote><ul><li>fetch返回的是<code>带数据的Promise</code></li><li>请求<code>默认不带cookie</code> --&gt; 配置credentials</li><li>IE8/IE9 --&gt; 不支持CORS --&gt; fetch-jsonp</li></ul></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>Fetch-实践</h2><hr><ul><li>如何使用 Fetch API 执行 HTTP 请求<ul><li><a href=https://www.css88.com/archives/9907 target=_blank>https:://www.css88.com/archives/9907</a></li></ul></li></ul><pre class=language-js><code class=language-js><span class="token keyword">function</span> <span class="token function">postData</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 默认选项用 * 表示</span>
  <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    body<span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 必须匹配 'Content-Type' header</span>
    cache<span class="token punctuation">:</span> <span class="token string">'no-cache'</span><span class="token punctuation">,</span> <span class="token comment">// *default, no-cache, reload, force-cache, only-if-cached</span>
    credentials<span class="token punctuation">:</span> <span class="token string">'same-origin'</span><span class="token punctuation">,</span> <span class="token comment">// include, same-origin, *omit</span>
    headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">'user-agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/4.0 MDN Example'</span><span class="token punctuation">,</span>
      <span class="token string">'content-type'</span><span class="token punctuation">:</span> <span class="token string">'application/json'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token comment">// *GET, POST, PUT, DELETE, etc.</span>
    mode<span class="token punctuation">:</span> <span class="token string">'cors'</span><span class="token punctuation">,</span> <span class="token comment">// no-cors, cors, *same-origin</span>
    redirect<span class="token punctuation">:</span> <span class="token string">'follow'</span><span class="token punctuation">,</span> <span class="token comment">// manual, *follow, error</span>
    referrer<span class="token punctuation">:</span> <span class="token string">'no-referrer'</span><span class="token punctuation">,</span> <span class="token comment">// *client, no-referrer</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// parses response to JSON</span>
<span class="token punctuation">}</span>

<span class="token function">postData</span><span class="token punctuation">(</span><span class="token string">'http://example.com/answer'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>answer<span class="token punctuation">:</span> <span class="token number">42</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// JSON ，来自 `response.json()` 调用</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>Fetch - 上传文件</h2><hr><pre class=language-js><code class=language-js><span class="token keyword">var</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> fileField <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"input[type='file']"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'abc123'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'avatar'</span><span class="token punctuation">,</span> fileField<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://example.com/profile/avatar'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  method<span class="token punctuation">:</span> <span class="token string">'PUT'</span><span class="token punctuation">,</span>
  body<span class="token punctuation">:</span> formData
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Error:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Success:'</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>swr</h2><hr><ul><li>2019-10-29 提交 --&gt; star 5.6k --&gt; <code>网红</code></li><li>@code <a href=https://github.com/zeit/swr target=_blank>https:://github.com/zeit/swr</a></li><li>多窗口同步功能</li><li>快速导航</li><li>条件与<code>依赖获取</code> --&gt; 只需要把顺序写好, 不需要async/await @nice</li><li>错误处理</li></ul><pre class=language-js><code class=language-js><span class="token function">useSWR</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> fetcher<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">onErrorRetry</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> key<span class="token punctuation">,</span> option<span class="token punctuation">,</span> revalidate<span class="token punctuation">,</span> <span class="token punctuation">{</span> retryCount <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>retryCount <span class="token operator">>=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">404</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token comment">// retry after 5 seconds</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">revalidate</span><span class="token punctuation">(</span><span class="token punctuation">{</span> retryCount<span class="token punctuation">:</span> retryCount <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>swr - 使用示例</h2><hr><pre class=language-js><code class=language-js><span class="token keyword">import</span> useSWR <span class="token keyword">from</span> <span class="token string">'swr'</span>

<span class="token keyword">function</span> <span class="token function">App</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> data<span class="token punctuation">,</span> error <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useSWR</span><span class="token punctuation">(</span><span class="token string">'/mock/user.json'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> r<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">></span>failed to load<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">></span>loading<span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">></span>hello <span class="token punctuation">{</span>data<span class="token punctuation">.</span>data<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token operator">!</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
<span class="token punctuation">}</span>
</code></pre></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>swr + suspense</h2><hr><pre class=language-js><code class=language-js><span class="token keyword">import</span> <span class="token punctuation">{</span> Suspense <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> useSWR <span class="token keyword">from</span> <span class="token string">'swr'</span>
<span class="token keyword">import</span> fetch <span class="token keyword">from</span> <span class="token string">'unfetch'</span>

<span class="token keyword">const</span> <span class="token function-variable function">fetcher</span> <span class="token operator">=</span> <span class="token parameter">url</span> <span class="token operator">=></span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> r<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">Profile</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useSWR</span><span class="token punctuation">(</span><span class="token string">'/mock/user.json'</span><span class="token punctuation">,</span> fetcher<span class="token punctuation">,</span> <span class="token punctuation">{</span> suspense<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// console.log(data)</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">></span>hello<span class="token punctuation">,</span> <span class="token punctuation">{</span> data<span class="token punctuation">.</span>data<span class="token punctuation">.</span>name <span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">App</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>Suspense fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&lt;</span>div<span class="token operator">></span>loading<span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
            <span class="token operator">&lt;</span>Profile<span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>Suspense<span class="token operator">></span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h1>swr - 条件取数 + 依赖取数</h1><hr><pre class=language-js><code class=language-js><span class="token comment">// 条件取数</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useSWR</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>shouldFetch <span class="token operator">?</span> <span class="token string">"/api/data"</span> <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fetcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><pre class=language-js><code class=language-js><span class="token comment">// 依赖取数</span>
<span class="token keyword">const</span> <span class="token function-variable function">fetcher</span> <span class="token operator">=</span> <span class="token parameter">url</span> <span class="token operator">=></span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> r<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">App</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果函数抛出异常，就意味着它的依赖还没就绪（users === undefined）</span>
    <span class="token comment">// SWR将暂停这个数据的请求</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> data<span class="token punctuation">:</span> users <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useSWR</span><span class="token punctuation">(</span><span class="token string">'/mock/users.json'</span><span class="token punctuation">,</span> fetcher<span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> data<span class="token punctuation">:</span> user <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useSWR</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">'/mock/user.json?name='</span> <span class="token operator">+</span> users<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> fetcher<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&lt;</span><span class="token operator">></span>loading<span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">></span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token operator">&lt;</span>ul<span class="token operator">></span>
        <span class="token punctuation">{</span> users<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>name<span class="token punctuation">}</span> style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
            color<span class="token punctuation">:</span> item<span class="token punctuation">.</span>name <span class="token operator">===</span> user<span class="token punctuation">.</span>data<span class="token punctuation">.</span>name <span class="token operator">?</span> <span class="token string">'red'</span> <span class="token punctuation">:</span> <span class="token string">'blue'</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">></span>
<span class="token punctuation">}</span>
</code></pre></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>谢谢倾听</h2><hr><p><img src=/static/images/thinking/xiong-hand.jpg alt=""></p></div></section><section slide class=slide :class="size-90 aligncenter"><div class="wrap size-90 aligncenter" wrap=true><h2>参考</h2><hr><ul><li>《JavaScript框架设计(第2版)》-异步模块 @by 司徒正美</li><li>前端精读周刊<ul><li><a href=https://github.com/dt-fe/weekly target=_blank>https:://github.com/dt-fe/weekly</a></li><li>精读《Hooks 取数 - swr 源码》</li></ul></li></ul></div></section></article></div><script>window.pluginsOptions = {}



document.addEventListener('DOMContentLoaded', () => {
    let isPrintMode = false;
    if(~location.search.indexOf('print-pdf')){
        isPrintMode = true;
        WebSlides.registerPlugin('scroll', function(){});
    }
    const ws = new WebSlides({
        loop: false
    })
    window.wsInstance = ws;
    if(isPrintMode){
        ws.slides.forEach(s=>s.show())
    }
}, false)</script><script src=./js/chunk-vendors.d658b63b.js></script><script src=./js/index.ad186c58.js></script></body></html>